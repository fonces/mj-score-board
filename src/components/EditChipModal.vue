<template>
  <ModalBase class="edit-chips-modal" title="チップ編集" @close="onClose">
    <List gap="24px">
      <div class="actions">
        <Button @click="onClear">クリア</Button>
        <div v-if="isDifference(model.chips)" class="error">{{ diff }}枚差分があります</div>
      </div>
      <div class="form-field chip-rate">
        <label>チップ1枚</label>
        <TextInput v-model.number="model.chipRate" type="tel" align="right" @blur="onBlurChipRate" />
        <label>点相当</label>
      </div>
      <List>
        <Item v-for="(player, i) in players" :key="i">
          <SectionTitle>{{ player }}</SectionTitle>
          <div class="form-field">
            <TextInput v-model.number="model.chips[i]" align="right" @blur="onBlur(i)" />
            <label>枚</label>
            <Button
              v-if="model.chips[i] === 0 && isDifference(model.chips)"
              small
              class="auto-input"
              @click="onAutoComplete(i)"
            >
              自動入力
            </Button>
          </div>
        </Item>
      </List>
    </List>
    <template #footer>
      <Button @click="onClose">キャンセル</Button>
      <Button primary :disabled="isDifference(model.chips)" @click="onSave">保存</Button>
    </template>
  </ModalBase>
</template>

<script>
import { reactive, computed } from 'vue'
import { fill } from '@/utils/array'
import { isDifference } from '@/utils/validator'
import Button from '@/components/atoms/Button.vue'
import TextInput from '@/components/atoms/TextInput.vue'
import SectionTitle from '@/components/atoms/SectionTitle.vue'
import List from '@/components/atoms/List.vue'
import Item from '@/components/atoms/Item.vue'
import ModalBase from '@/components/molecules/ModalBase.vue'

export default {
  name: 'EditChipModal',
  components: {
    Button,
    TextInput,
    SectionTitle,
    List,
    Item,
    ModalBase,
  },
  props: {
    players: {
      type: Array,
      required: true,
    },
    chips: {
      type: Array,
      required: true,
    },
    chipRate: {
      type: Number,
      required: true,
    },
  },
  setup(props, { emit }) {
    const model = reactive({
      chips: [...props.chips],
      chipRate: props.chipRate,
    })
    const diffRef = computed(() => model.chips.reduce((acc, s) => acc += +s, 0))

    return {
      isDifference,
      model,
      diff: diffRef,
      onBlur: i => !Number.isInteger(model.chips[i]) && (model.chips[i] = 0),
      onBlurChipRate: () => (!Number.isInteger(model.chipRate) || model.chipRate % 1000 !== 0) && (model.chipRate = props.chipRate),
      onAutoComplete: i => model.chips[i] -= diffRef.value,
      onClear: () => model.chips = fill(props.players.length),
      onClose: () => emit('close'),
      onSave: () => emit('save', { ...model, chips: [...model.chips] }),
    }
  }
}
</script>

<style scoped>
.actions {
  align-items: center;
  display: flex;
  flex-direction: row-reverse;
  justify-content: space-between;
}

.error {
  color: var(--error);
  font-size: 13px;
  font-weight: bold;
}

.form-field {
  align-items: center;
  display: grid;
  gap: 8px;
  grid-auto-flow: column;
  grid-template-columns: 1fr max-content max-content;
}

.chip-rate {
  grid-template-columns: max-content 1fr max-content;
}
</style>